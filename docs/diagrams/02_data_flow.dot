digraph DataFlow {
    graph [bgcolor="#0a0e27", fontname="JetBrains Mono", fontsize=12, rankdir=TB, splines=polyline, pad=0.5, nodesep=0.7, ranksep=1.0];
    node [fontname="JetBrains Mono", fontsize=10, style="filled,rounded", shape=box, margin=0.25];
    edge [fontname="JetBrains Mono", fontsize=9, arrowsize=0.8];

    // Title
    label=<
        <table border="0" cellborder="0" cellspacing="0">
            <tr><td><font point-size="24" color="#ff00ff"><b>ğŸ”„ EVIDENCE DATA FLOW</b></font></td></tr>
            <tr><td><font point-size="12" color="#00d4ff">From Detectors â†’ EvidenceRegistry â†’ AnswerAssembler â†’ 300-Question Evaluation</font></td></tr>
        </table>
    >;
    labelloc="t";

    // Detectors (Stage 5-11)
    subgraph cluster_detectors {
        label=<
            <font color="#00ff88"><b>ğŸ“Š DETECTORS (Stage 5-11)</b></font>
        >;
        style=filled;
        fillcolor="#1a1f35";
        color="#00ff88";
        penwidth=2;

        resp [label="ğŸ¯ Responsibility\nDetector", fillcolor="#2a1f3a", color="#ff00ff", fontcolor="#ffffff"];
        contra [label="âš ï¸ Contradiction\nDetector", fillcolor="#2a1f3a", color="#ff00ff", fontcolor="#ffffff"];
        money [label="ğŸ’° Monetary\nDetector", fillcolor="#2a1f3a", color="#ff00ff", fontcolor="#ffffff"];
        feas [label="ğŸ“ˆ Feasibility\nScorer", fillcolor="#2a1f3a", color="#ff00ff", fontcolor="#ffffff"];
        causal [label="ğŸ”— Causal Pattern\nDetector", fillcolor="#2a1f3a", color="#ff00ff", fontcolor="#ffffff"];
        toc [label="ğŸ¯ TeorÃ­a\nCambio", fillcolor="#2a1f3a", color="#ff00ff", fontcolor="#ffffff"];
        dag [label="ğŸŒ³ DAG\nValidation", fillcolor="#2a1f3a", color="#ff00ff", fontcolor="#ffffff"];
    }

    // Evidence Registry (Stage 12)
    registry [label=<
        <table border="0" cellborder="1" cellspacing="0" cellpadding="10" bgcolor="#1a3040" color="#00ffff">
            <tr><td bgcolor="#00ffff" colspan="2"><font color="#000000"><b>ğŸ“¦ EVIDENCE REGISTRY (Stage 12)</b></font></td></tr>
            <tr><td align="left" colspan="2"><font color="#ffffff"><b>Single Source of Truth</b></font></td></tr>
            <tr><td align="left"><font color="#ffff00">â€¢ Deterministic Hash</font></td><td align="left"><font color="#00ffff">evidence_hash</font></td></tr>
            <tr><td align="left"><font color="#ffff00">â€¢ Provenance</font></td><td align="left"><font color="#00ffff">source_segment_ids</font></td></tr>
            <tr><td align="left"><font color="#ffff00">â€¢ Indexing</font></td><td align="left"><font color="#00ffff">by_stage, by_segment</font></td></tr>
            <tr><td align="left"><font color="#ffff00">â€¢ Thread-safe</font></td><td align="left"><font color="#00ffff">Lock mechanism</font></td></tr>
        </table>
    >, fillcolor="#1a3040", color="#00ffff", penwidth=3];

    // Evaluators (Stage 13-14)
    subgraph cluster_evaluators {
        label=<
            <font color="#ffff00"><b>ğŸ“ EVALUATORS (Stage 13-14)</b></font>
        >;
        style=filled;
        fillcolor="#1f1f2a";
        color="#ffff00";
        penwidth=2;

        decalogo [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="6">
                <tr><td><font color="#00ffff"><b>ğŸ“‹ DecÃ¡logo Evaluator</b></font></td></tr>
                <tr><td><font color="#ffffff">Dimension-based</font></td></tr>
            </table>
        >, fillcolor="#1a2435", color="#ffff00", fontcolor="#ffffff"];

        questionnaire [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="6">
                <tr><td><font color="#00ffff"><b>â“ Questionnaire Engine</b></font></td></tr>
                <tr><td><font color="#ffffff">300 Questions</font></td></tr>
            </table>
        >, fillcolor="#1a2435", color="#ffff00", fontcolor="#ffffff"];
    }

    // Answer Assembler (Stage 15)
    assembler [label=<
        <table border="0" cellborder="1" cellspacing="0" cellpadding="10" bgcolor="#1a1f40" color="#00ff88">
            <tr><td bgcolor="#00ff88" colspan="2"><font color="#000000"><b>ğŸ”§ ANSWER ASSEMBLER (Stage 15)</b></font></td></tr>
            <tr><td align="left"><font color="#ffff00">Input:</font></td><td align="left"><font color="#ffffff">evidence_store + evaluations</font></td></tr>
            <tr><td align="left"><font color="#ffff00">Process:</font></td><td align="left"><font color="#ffffff">Merge + Score + Reason</font></td></tr>
            <tr><td align="left"><font color="#ffff00">Output:</font></td><td align="left"><font color="#ffffff">300 Structured Answers</font></td></tr>
            <tr><td align="left" colspan="2"><font color="#00ffff"><b>âœ“ Gate #4: Coverage â‰¥ 300</b></font></td></tr>
            <tr><td align="left" colspan="2"><font color="#00ffff"><b>âœ“ Gate #5: Rubric Aligned</b></font></td></tr>
        </table>
    >, fillcolor="#1a1f40", color="#00ff88", penwidth=3];

    // Final Output
    output [label=<
        <table border="0" cellborder="1" cellspacing="0" cellpadding="8" bgcolor="#1a1a30" color="#ff00ff">
            <tr><td bgcolor="#ff00ff"><font color="#000000"><b>ğŸ“„ ANSWERS REPORT</b></font></td></tr>
            <tr><td align="left"><font color="#ffffff">300 Questions</font></td></tr>
            <tr><td align="left"><font color="#00ffff">â€¢ evidence_ids</font></td></tr>
            <tr><td align="left"><font color="#00ffff">â€¢ confidence</font></td></tr>
            <tr><td align="left"><font color="#00ffff">â€¢ score</font></td></tr>
            <tr><td align="left"><font color="#00ffff">â€¢ reasoning</font></td></tr>
            <tr><td align="left"><font color="#00ffff">â€¢ supporting_quotes</font></td></tr>
        </table>
    >, fillcolor="#1a1a30", color="#ff00ff", penwidth=2];

    // Flow edges with cardinality
    resp -> registry [label="N:1\nresp_*", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    contra -> registry [label="N:1\ncontra_*", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    money -> registry [label="N:1\nmoney_*", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    feas -> registry [label="N:1\nfeas_*", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    causal -> registry [label="N:1\ncausal_*", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    toc -> registry [label="N:1\ntoc_*", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    dag -> registry [label="N:1\ndag_*", color="#00ffff", fontcolor="#00ffff", penwidth=2];

    registry -> decalogo [label="1:1\nRead-Only", color="#ffff00", fontcolor="#ffff00", penwidth=2, style="bold"];
    registry -> questionnaire [label="1:1\nRead-Only", color="#ffff00", fontcolor="#ffff00", penwidth=2, style="bold"];

    decalogo -> assembler [label="1:1\ndecalogo_eval", color="#00ff88", fontcolor="#00ff88", penwidth=2];
    questionnaire -> assembler [label="1:1\nquestionnaire_eval", color="#00ff88", fontcolor="#00ff88", penwidth=2];
    registry -> assembler [label="1:1\nevidence_store", color="#00ff88", fontcolor="#00ff88", penwidth=3, style="bold"];

    assembler -> output [label="1:1\n300 Answers", color="#ff00ff", fontcolor="#ff00ff", penwidth=3, style="bold"];

    // Annotations
    fanin [label="FAN-IN\nN:1", shape=diamond, fillcolor="#ff00ff", color="#ff00ff", fontcolor="#000000", style="filled"];
    fanin -> registry [style="invis"];
}
